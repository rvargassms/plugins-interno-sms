tinymce.PluginManager
		.add(
				'cloak',
				function(editor, url) {
					editor.addMenuItem('cloak', {
						text : 'Cloak',
						context : 'tools',
						icon : 'mce-ico mce-i-code',
						onclick : function() {
							editor.insertContent(getCloak());
						}
					});
					editor.addButton('Cloak', {
						title : 'Insertar Cloak',
						icon : 'mce-ico mce-i-code',
						onclick : function() {
							editor.insertContent(getCloak());
							handlePaste(editor.getBody());
						}
					});

					function getCloak() {
						return [
								'<table class="panel panel-info cloak ">',
									'<tr><td class="panel-heading panel-heading-info panel-title tituloColapsable cloak-title">',
										'<p>',
											'<span class=""> T&iacute;tulo izquierdo </span>',
											'<span class="icono mceEditable icon-cloak-open" data-mce-contenteditable="true">',
												'<button title="Cerrar cloak" class="cloakClose" style=" background-image: url(\'/html/images/cerrar.gif\');background-position: 3px; background-repeat: no-repeat; cursor:pointer;">&nbsp;</button>',
												'<button title="Abrir cloak" class="cloakOpen" style=" background-image: url(\'/html/images/abrir.gif\');background-position: 3px; background-repeat: no-repeat; cursor:pointer; display:none">&nbsp;</button>',
											'</span>',
											'<span class=""> T&iacute;tulo derecho </span>',
											"<span class='pull-right mceNonEditable'><span class='glyphicon glyphicon-remove delete-panel' aria-hidden='true' ></span></span>",
										'</p>',
									'</td></tr>',
									'<tr><td class="panel-body ocultable cloak-body" >',
										'<p>Contenido</p>', 
									'</td></tr>', 
								'</table>', ]
								.join('');
					};
					
					/**Previene que los estilos del cloak se descompongan al copiar y pegar en Chrome*/
					function handlePaste(elementBody){
							elementBody.addEventListener('paste', function (e) {
								var clipboardData, pastedData;

								// Stop data actually being pasted into div
								e.stopPropagation();
								e.preventDefault();

									// Get pasted data via clipboard API
								clipboardData = e.clipboardData || window.clipboardData;
								pastedData = clipboardData.getData('Text');
								
								// Do whatever with pasteddata
							});
					};

					/** Table cloak **/
					editor.addMenuItem('tableCloak', {
						text : 'Cloak en tabla',
						context : 'tools',
						icon : 'mce-ico mce-i-code',
						onclick : function() {
							
							if (editor.selection.getNode().nodeName != "TD" && jQuery(editor.selection.getNode()).parents("td").length == 0 ){
								editor.windowManager.alert('No es posible insertar un cloak de tabla fuera de una tabla');
								return;
							}
							if (editor.selection.getNode().nodeName == "TD")
								var tdNode = editor.selection.getNode();
							else
								var tdNode = jQuery(editor.selection.getNode()).parents("td")[0];
								
							var nextSibling = tdNode.nextSibling;
							
							if (!nextSibling || nextSibling.nodeName != "TD"){
								editor.windowManager.alert('No es posible insertar un cloak de tabla en la Ãºltima columna');
								return;
							}
							
							tdNode.className = "confluenceTd panel-heading panel-heading-info cloak-title table-cloak-title";
							
							editor.insertContent([
													'<p>',
														'<span class=""> T&iacute;tulo izquierdo </span>',
														'<span class="icono mceEditable icon-cloak-closed" data-mce-contenteditable="true">',
															'<button title="Abrir cloak" class="table-cloak-open" style=" background-image: url(\'/html/images/cerrar.gif\');background-position: 3px; background-repeat: no-repeat; cursor:pointer;">&nbsp;</button>',
															'<button title="Cerrar cloak" class="table-cloak-close" style=" background-image: url(\'/html/images/abrir.gif\');background-position: 3px; background-repeat: no-repeat; cursor:pointer; display:none">&nbsp;</button>',
														'</span>',
														'<span class=""> T&iacute;tulo derecho </span>',
													'</p>',
													].join('')
							);
							jQuery(editor.selection.getNode()).parents("td")[0].nextSibling.className = "confluenceTd table-cloak-body table-cloak-body-closed";
						
					}});
					/** end - Table cloak **/

				});
